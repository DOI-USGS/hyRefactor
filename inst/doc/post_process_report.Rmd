---
title: "NHDPlus Network Refactor Report"
author: "dblodgett@usgs.gov"
date: "3/21/2018"
output: html_document
---

```{r setup,  include=FALSE}
library(nhdplusTools)
library(dplyr)
library(sf)
options(scipen = 9999)
```

## NHDPlus Network Refactor
The report below summarizes a project to normalize flowline length in the NHDPlusV2 and NWM networks by splitting long flow lines and collapsing short flowlines. The code developed for this is parameterizable and this report is presented with target lengths of 2km for long flowlines splits and 0.5km for minimum flowlines length. 

The first section describes the NHDPlus Network as it exists without modification. Following that, each processing step is illustrated and final results are summarized.

Prior to summarizing the network, some NHDPlus conditioning needs to be performed. The following function removes coastal and non-dendritic flowlines. It can also remove networks with an outlet drainage area under a threshold or a longest path length under a threshold, but those inputs are set to 0 such that all networks are included.

```{r prep_flowlines, eval=FALSE}
nhdplus_path <- "../../1_data/NHDPlusV21_National_Seamless.gdb/"
nhdplus_layers <- sf::st_layers(nhdplus_path)
nhdplus_flines <- sf::st_read(nhdplus_path, "NHDFlowline_Network")
min_network_size <- 0
min_path_length <- 0
flines <- prepare_nhdplus(st_set_geometry(nhdplus_flines, NULL), 
                          min_network_size, min_path_length)
```
```{r secret_prep, echo=FALSE}
min_network_size <- 0
min_path_length <- 0
# saveRDS(flines, "preped_flines_cache.rds")
# saveRDS(nhdplus_flines, "nhdplus_flowlines_geo.rds")
flines <- readRDS("preped_flines_cache.rds")
nhdplus_flines <- readRDS("nhdplus_flowlines_geo.rds")
```


The following histograms and plots show characteristics of the NHDPlusV2 network flowline lengths.
```{r nhdplus, echo=FALSE}
hist(flines$LENGTHKM, breaks = 100, main = "NHDPlus Flowlines",
     xlab = "flowline length (km)")

excluded <- length(flines$LENGTHKM[which(flines$LENGTHKM > 10)])

hist(flines$LENGTHKM[which(flines$LENGTHKM < 10)], breaks = 100,
     main = paste0("NHDPlus Flowlines Less than 10km long. \n", excluded, " of ",
                   nrow(flines), " truncated."),
     xlab = "flowline length (km)")

tot_flowlines <- nrow(flines)

flow_length_ecdf <- ecdf(flines$LENGTHKM)
flow_length <- data.frame(l_km = c(0.01, 0.1,1,2,3,4,5,7,10))
flow_length$percent <- flow_length_ecdf(flow_length$l_km)*100
plot(flow_length, main = "Percent of flowlines shorter than ...", xlab = "km")
grid(col="black")

max_l <- .5 #km

flow_length_low <- data.frame(l_km = c(0.01, 0.05, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1))
flow_length_low$count <- flow_length_ecdf(flow_length_low$l_km)*tot_flowlines
plot(flow_length_low, main = "Number of flowlines shorter than ...", xlab = "km")
grid(col="black")

flow_length_high <- data.frame(l_km = c(4, 5, 6, 7, 8, 9, 10, 12, 15, 20, 25, 30))
flow_length_high$count <- tot_flowlines - flow_length_ecdf(flow_length_high$l_km)*tot_flowlines
plot(flow_length_high, main = "Number of flowlines longer than ...", xlab = "km")
grid(col="black")
```

## nhdplus_refactor function
The complete refactor workflow has been packaged into a single function that can be called as shown below. For the purposes of demonstration this function is not used and individual package functions called by it are shown.
```{r demo, eval=FALSE, echo=TRUE}
## Not Run ##
nhdplus_refactor(nhdplus_flines = nhdplus_flowlines,
                 split_flines_meters = 2000, split_flines_cores = 3,
                 collapse_flines_meters = 500, collapse_flines_mainstem_meters = 500,
                 out_collapsed = "nhdplus_collapsed.gpkg",
                 out_reconciled = "nhdplus_reconciled.gpkg",
                 three_pass = TRUE)
```
The inputs to this are:

* nhdplus_flines: raw nhdplus flowline features as derived from the national seamless geodatabase.
* split_flines_meters: the maximum length flowline desired in the output.
* split_flines_cores: the number of processing cores to use while splitting flowlines.
* collapse flines_meters: the minimum length of inter-confluence flowline desired in the output.
* collapse_flines_mainstem_meters: the minimum length of between-confluence flowlines.
* out_collapsed: where to write a geopackage containing the split and collapsed flowlines.
* out_reconciled: where to write a geoppackage containing the reconciled flowlines.
* three_pass: whether to perform a three pass collapse or single pass.
These inputs are described in detail below.

## Split flowlines
The split_flowlines feature requires flowlines with geometry but for performance reasons, the prep_nhdplus function works with attributes only. The code below, joins the geometry back, coerces it to the required geometry type, and projects it to a projection suited to distance measurement at the contental scale of NHDPlus. It then executes the split_flowlines function.
```{r split, eval=FALSE}
flines <- inner_join(flines, select(nhdplus_flines, COMID), by = "COMID") %>%
    st_as_sf() %>%
    st_cast("LINESTRING") %>%
    st_transform(5070)

flines <- split_flowlines(flines, 
                          max_length = 2000, 
                          para = 3)


```
```{r split_secret, echo=FALSE}
# saveRDS(flines, "split_flines_cache.rds")
rm(nhdplus_flines)
flines <- readRDS("split_flines_cache.rds")
```

```{r split_plots, echo=FALSE}
hist(flines$LENGTHKM, breaks = 100, main = "Split NHDPlus Flowlines",
     xlab = "flowline length (km)")
```

As can be seen here, `split_flowlines` breaks long flowlines into equal length pieces, which results in the new distribution of flowline lengths shown. 

## Collapse Flowlines
Now we can collapse very short flowlines. 
```{r collapse1, eval=FALSE}
collapse_flines_meters <- 500
collapse_flines_mainstem_meters <- 500
collapsed_flines <- collapse_flowlines(st_set_geometry(flines, NULL),
                                           (0.25*collapse_flines_meters/1000),
                                           TRUE,
                                           (0.25*collapse_flines_mainstem_meters/1000))
```

```{r collapse1_secret, echo=FALSE}
# saveRDS(collapsed_flines, "collapsed_flines1_cache.rds")
collapsed_flines <- readRDS("collapsed_flines1_cache.rds")

excluded <- length(collapsed_flines$LENGTHKM[which(collapsed_flines$LENGTHKM == 0)])

hist(collapsed_flines$LENGTHKM[which(collapsed_flines$LENGTHKM > 0)], breaks = 100,
     main = paste0("Collapsed NHDPlus Flowlines. \n", excluded, " of ",
                   nrow(collapsed_flines), " removed in collapse."),
     xlab = "flowline length (km)")
```
As can be seen here, some collapsed flowlines extend the split flowlines. This is a result of chains of very short flowlines being combined together. This problem is more or less unavoidable but is improved by running the collapse step a few times with small to large input thresholds as is done next.

## Collapse step two and three
Now we can collapse twice more

```{r collapse2, eval=FALSE}
collapsed_flines <- collapse_flowlines(collapsed_flines,
                                       (0.5*collapse_flines_meters/1000),
                                       TRUE,
                                       (0.5*collapse_flines_mainstem_meters/1000))

collapsed_flines <- collapse_flowlines(collapsed_flines,
                                       (collapse_flines_meters/1000),
                                       TRUE,
                                       (collapse_flines_mainstem_meters/1000))

# Now we can save the output
collapsed_flines %>%
    inner_join(select(flines, COMID), by = "COMID") %>%
    st_as_sf() %>%
    st_transform(4326) %>%
    st_write("nhdplus_collapsed.gpkg", layer_options = "OVERWRITE=YES")
```

```{r collapse2_secret, echo=FALSE}
# saveRDS(collapsed_flines, "collapsed_flines2_cache.rds")
collapsed_flines <- readRDS("collapsed_flines2_cache.rds")

excluded <- length(collapsed_flines$LENGTHKM[which(collapsed_flines$LENGTHKM == 0)])

hist(collapsed_flines$LENGTHKM[which(collapsed_flines$LENGTHKM > 0)], breaks = 100,
     main = paste0("Collapsed NHDPlus Flowlines. \n", excluded, " of ",
                   nrow(collapsed_flines), " removed in collapse."),
     xlab = "flowline length (km)")
```
As shown here, the distribution of flowline lengths is much tighter now but very small headwaters and long chains of collapsed flowlines remain out of the desired range. For the sake of completness, 

```{r single_pass, eval=FALSE}
collapsed_flines_one_pass <- collapse_flowlines(st_set_geometry(flines, NULL),
                                                (collapse_flines_meters/1000),
                                                TRUE,
                                                (collapse_flines_mainstem_meters/1000))
```

```{r collapseonepass_secret, echo=FALSE}
# saveRDS(collapsed_flines_one_pass, "collapsed_flinesonepass_cache.rds")
collapsed_flines_one_pass <- readRDS("collapsed_flinesonepass_cache.rds")

excluded <- length(collapsed_flines_one_pass$LENGTHKM[which(collapsed_flines_one_pass$LENGTHKM == 0)])

hist(collapsed_flines_one_pass$LENGTHKM[which(collapsed_flines_one_pass$LENGTHKM > 0)], breaks = 100,
     main = paste0("Collapsed NHDPlus Flowlines. \n", excluded, " of ",
                   nrow(collapsed_flines_one_pass), " removed in collapse."),
     xlab = "flowline length (km)")
```
As shown in this historigram, the problem of long chains of collapsed flowlines is much worse when the collapse is run only once.

## Reconcile collapsed flowlines
Now that we have our flowlines collapsed, we need to reconcile the results into merged geometries with updated ids. The reconcile_collapsed_flowlines function does this including a column that contains a comma seperated list of catchment ids that were merged together to form each new flowline. 
```{r reconcile, eval=FALSE}
collapsed <- reconcile_collapsed_flowlines(collapsed_flines, 
                                           geom = st_zm(select(flines, COMID)), 
                                           id = "COMID")

# convert member_COMID from list to string for output
collapsed$member_COMID <- unlist(lapply(collapsed$member_COMID, function(x) paste(x, collapse = ",")))
# And write output  
st_write(st_transform(collapsed, 4326), "nhdplus_reconciled.gpkg", layer_options = "OVERWRITE=YES")
```

```{r reconcile_secret, echo=FALSE}
# saveRDS(collapsed, "reconcile_collapsed_cache.rds")
collapsed <- readRDS("reconcile_collapsed_cache.rds")

hist(collapsed$LENGTHKM, breaks = 100,
     main = "Collapsed and reconciled NHDPlus Flowlines",
     xlab = "flowline length (km)")
```

## Examples
![](images/general_demo.png)  
This image (and those below) show the original NHDPlus network in blue with streams greater than first order rendered with a thick blue line. Blue dots are where the original NHDPlus flowline breaks were and red dots are where the new refactored flowline breaks are. Notice that lone red dots are the result of splitting flowlines and lone blue dots are the result of collapsing them.

![](images/combination_chain.png)  
This image shows an example of a chain combination. All the small tributaries that intersect the highlighted mainstem are routed to the outlet of the mainstem flowline and have a length attribute that is the distance to that outlet. This problem is especially common where there is a high density of small tributaries meeting a mainstem like in the case shown here. The longest tributary here routed to the oulet of the mainstem is the longest single flowline in the result set (5.5km) shown in the histogram above.

![](images/headwater_combo.png)  
This image shows how short headwater flowlines can be combined downstream. The two open blue dots are where three short flowlines were collapsed into one 2km long flowline.

![](images/coastal_zoom_out.png)  
This image shows a coastal system with very long flowlines that have largely been split into many pieces.

![](images/coastal_zoom_in.png)  
This image is a zoomed in view of the outlet and coastal drainages of the system in the image above. Not that there are numerous single-flowling coastal systems in the NHDPlus.
